<!DOCTYPE html>
{% load photoyotetags %}
{% load static %}
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'jquery/jquery.mobile-1.4.5.min.css' %}" rel="stylesheet">
    <script src="{% static 'jquery/jquery-2.1.3.min.js' %}"></script>
    <script src="{% static 'jquery/jquery.mobile-1.4.5.min.js' %}"></script>
    <script src="{% static 'jquery/jquery.cookie.js' %}"></script>
    <script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
</head>
<body>
<style>
    .col-xs-6 {
        padding: 2px;
    }
    .col-xs-6 a {
        margin-bottom: 0;
    }

    .thumbnail {
        position: relative;
        z-index: 0;
    }

    .tn-rejected {
        background-color: #c0c0c0;
    }
</style>
<script>
    var media_list=[
    {% for media in filmstrip %}    {
            id: "{{media.id}}",
            filename: "{{media.filename}}",
            date: "{{media.date|date:'Y-m-d H:i'}}",
            thumbnail: "{{media|thumbnail}}",
            preview: "{{media|preview}}",
            fullsize: "{{media|fullsize}}"
        },
    {% endfor %}];

    function get_index_by_id(id) {
        for (idx=0; idx < media_list.length; idx++) {
            if (media_list[idx].id == id) return idx;
        }
        return 0;
    }

    function slide_id(idx) {
        return '#slide-'+media_list[idx].id;
    }

    function verify_index(idx) {
        if (idx < 0) return 0;
        if (idx >=  media_list.length) return media_list.length-1;
        return idx;
    }

    function set_preview_image() {
        var next_media=verify_index(cur_media+1);
        $("#media-next").prop('disabled', next_media == cur_media);

        var prev_media=verify_index(cur_media-1);
        $("#media-prev").prop('disabled', prev_media == cur_media);

        $("#img-preview").attr("src", media_list[cur_media].preview);
        $("#img-preview-next").attr("src", media_list[next_media].preview);
        $("#img-preview-prev").attr("src", media_list[prev_media].preview);
        window.location.hash=media_list[cur_media].id;
        set_image_metadata();
        set_filmstrip_slide(cur_media);
    }

    function exposure(tval) {
        if (tval < 1)
            return "1/"+(1/tval).toFixed(0);
        return tval.toFixed(0);
    }

    function rating_stars_1(element, rating) {
        stars=$(element+" > .glyphicon");
        for (r=0; r < 5; r++) {
            if (r < rating) {
                $(stars[r]).removeClass("glyphicon-star-empty");
                $(stars[r]).addClass("glyphicon-star");
            } else {
                $(stars[r]).removeClass("glyphicon-star");
                $(stars[r]).addClass("glyphicon-star-empty");
            }
        }
    }

    function rating_stars_2(element, rating) {
        stars=$(element+" > .glyphicon");
        console.log(stars);
        for (r=0; r < 5; r++) {
            // $(stars[r]).removeClass("glyphicon-star-empty");
            if (r < rating) {
                $(stars[r]).addClass("glyphicon-star");
            } else {
                $(stars[r]).removeClass("glyphicon-star");
            }
        }
    }

    function update_image_metadata(data) {
        $("#media-file").html(data.mediafile_path.split('/').pop());
        $("#media-date").html(data.date);
        $("#media-mime-type").html(data.mime_type);
        $("#media-catalog").html(data.catalog);
        $("#media-label").html(data.label);
        rating_stars_1("#media-rating", data.rating);
        $("#media-rejected").html(data.rejected? "True":"False");
        $("#media-exposure").html(exposure(data.exposure_time));
        $("#media-f-number").html(data.f_number);
        $("#media-focal-length").html(data.focal_length);
        $("#media-gain").html(data.gain_value);

        rating_stars_2(".stars-"+data.id, data.rating);
    }

    var cur_media_meta_data;

    function set_image_metadata(values) {
        var data;
        if (values == undefined) {
            type = "GET";
        } else {
            var type = "POST";
            values["csrfmiddlewaretoken"] = csrftoken;
            data = $.param(values);
            console.log(data);
        }

        $.ajax({
            url: "{% url 'metadata' %}"+media_list[cur_media].id,
            type: type,
            data: values,
            dataType: "json",
            success: function(json) {
                cur_media_meta_data=json[0].fields;
                cur_media_meta_data['id']=json[0].pk;
                update_image_metadata(cur_media_meta_data);
            },
            error: function(xhr, status, errorThrown) {
                console.log("Error: "+errorThrown);
                console.log("Status: "+status);
                console.dir( xhr);
            }
        });
    }

    function previous_image() {
        cur_media = verify_index(cur_media-1);
        set_preview_image();
    }

    function next_image() {
        cur_media = verify_index(cur_media+1);
        set_preview_image();
    }

    function set_rating() {
        rating=$(this).attr("id").split("-").pop();
        if (cur_media_meta_data.rating == rating)
            rating--;
        if (rating < 0)
            rating=1;
        rating_stars_1("#"+$(this).parent().attr("id"), rating);
        cur_media_meta_data.rating = rating;
        set_image_metadata({rating: rating});
    }

    var cur_highlight=0;
    var strip_first=0;

    function set_filmstrip_slide(highlight) {
        var last=highlight+3;
        if (last >= media_list.length) last=media_list.length-1;
        var first=last-5;
        if (first < 0) {
            first=0;
            last=5;
        }
        for (idx = 0; idx < first; idx++)
            $(slide_id(idx)).hide();
        for (idx = last; idx < media_list.length; idx++)
            $(slide_id(idx)).hide();
        for (idx = first; idx <= last; idx++)
            $(slide_id(idx)).show();

        $(slide_id(cur_highlight)).css('border-style', 'none');
        $(slide_id(highlight)).css('border-style', 'solid');
        cur_highlight=highlight;
        strip_first=first;
    }

    function slide_strip_left() {
        if (strip_first >= media_list.length-6) return;
        $(slide_id(strip_first)).hide();
        $(slide_id(strip_first+6)).show();
        strip_first++;
    }

    function slide_strip_right() {
        if (strip_first == 0) return;
        strip_first--;
        $(slide_id(strip_first+6)).hide();
        $(slide_id(strip_first)).show();
    }

    var slide_scroll_mouse_pos;
    function slide_scroll(ev) {
        ev.preventDefault();
        ev.stopPropagation();

        var delta = ev.pageX - slide_scroll_mouse_pos;
        if (Math.abs(delta) < 40) return;

        if (delta > 0)
            slide_strip_right();
        else
            slide_strip_left();

        slide_scroll_mouse_pos = ev.pageX;
    }

    function slide_start_scroll(ev) {
        slide_scroll_mouse_pos = ev.pageX;
        $(this).on("mousemove vmousemove", slide_scroll);
        ev.preventDefault();
        ev.stopPropagation();
    }

    function slide_stop_scroll(ev) {
        $(this).off("mousemove");
        $(this).off("vmousemove");
    }

    function slide_stop_swipe(ev) {
    }

    function setup_filmstrip() {
        for (idx=0; idx < media_list.length; idx++) {
            media=media_list[idx];
            $('#slide-'+media.id+' > div > img').on("click vclick", {idx: idx}, function(ev) {
                cur_media = ev.data.idx;
                set_preview_image();
            });
        }
    }

    var media_id=window.location.hash.substring(1);
    var cur_media = get_index_by_id(media_id);
    var csrftoken = $.cookie('csrftoken');

    $(document).ready(function(){
        console.log(csrftoken);
        set_preview_image();
        setup_filmstrip();
        $("#img-preview").on("dragstart", function() { return false; });

        $("#media-prev").on("click", previous_image);
        $("div.preview").on("swiperight", previous_image);
        $("#media-next").on("click", next_image);
        $("div.preview").on("swipeleft", next_image);

        $("div.filmstrip").on("mousedown vmousedown", slide_start_scroll);
        $("div.filmstrip").on("mouseup mouseleave vmouseup", slide_stop_scroll);

        for(s=1; s < 6; s++)
            $("#rating-"+s).on("click", set_rating);
    });
</script>
<div class="preview">
    <div class="preview-with-nav">
        <button id="media-prev" type="button" class="btn btn-default btn-md">
            <span class="glyphicon glyphicon-menu-left"></span>
        </button>
        <div class="img-preview-container" style="height: 480px"><img id="img-preview" /></div>
        <button id="media-next" type="button" class="btn btn-default btn-lg">
            <span class="glyphicon glyphicon-menu-right"></span>
        </button>
    </div>
    <div class="media-meta-data">
        <div>File: <span id="media-file"></span></div>
        <div>Date: <span id="media-date"></span></div>
        <div>Type: <span id="media-mime-type"></span></div>
        <div>Catalog: <span id="media-catalog"></span></div>
        <div>Label: <span id="media-label"></span></div>
        <div></div>Rating: <span id="media-rating">
            <span id="rating-1" class="glyphicon glyphicon-star-empty"></span>
            <span id="rating-2" class="glyphicon glyphicon-star-empty"></span>
            <span id="rating-3" class="glyphicon glyphicon-star-empty"></span>
            <span id="rating-4" class="glyphicon glyphicon-star-empty"></span>
            <span id="rating-5" class="glyphicon glyphicon-star-empty"></span>
        </span></div>
        <div>Rejected: <span id="media-rejected"></span></div>

        <div>Exposure: <span id="media-exposure"></span></div>
        <div>F Number: <span id="media-f-number"></span></div>
        <div>Focal Length: <span id="media-focal-length"></span></div>
        <div>ISO/Gain: <span id="media-gain"></span></div>
    </div>
</div>
<div class="filmstrip">
    <div class="row">
        {% for media in filmstrip %}
        <div class="col-xs-6 col-md-2" id="slide-{{media.id}}" style="display: none">
            <div class="thumbnail {% if media.rejected %}tn-rejected{% endif %}">
                <img src="{{media|thumbnail}}" />
                <div class="caption">
                    <div>{{media.mediafile_path|basename}}</div>
                    <div>{{media.date|date:'Y-m-d H:i'}}</div>
                    <span class="stars-{{media.id}}">
                        <span class="glyphicon {% if media.rating > 0 %}glyphicon-star{% endif %}"></span>
                        <span class="glyphicon {% if media.rating > 1 %}glyphicon-star{% endif %}"></span>
                        <span class="glyphicon {% if media.rating > 2 %}glyphicon-star{% endif %}"></span>
                        <span class="glyphicon {% if media.rating > 3 %}glyphicon-star{% endif %}"></span>
                        <span class="glyphicon {% if media.rating > 4 %}glyphicon-star{% endif %}"></span>
                    </span>
                    <span class="glyphicon {% if media.rejected %}glyphicon-trash{% endif %}"></span>
                    <span class="glyphicon {% if media.label %}{% if media.label != 'None' %}glyphicon-flag" style="color: {{media.label}}{% endif %}{% endif %}"></span>
                    <span class="glyphicon {% if media.catalog != catalog %}glyphicon-export{% endif %}"></span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div style="display: none">
    <img id="img-preview-prev" />
    <img id="img-preview-next" />
</div>
</body>
</html>